#!/usr/bin/env bash
#-*- coding:utf-8 -*-

# Check dependencies
if ! command -v git >/dev/null 2>&1; then
  echo "Missing dependency: git. Please install git and rerun."
  exit 1
fi
if ! command -v curl >/dev/null 2>&1; then
  echo "Missing dependency: curl. Please install curl and rerun."
  exit 1
fi
echo "==> Checking Node.js runtime"
ensure_node() {
  if command -v node >/dev/null 2>&1; then
    echo "Node.js detected: $(node -v)"
    return 0
  fi
  echo "Node.js not found. Attempting installation..."
  os_type="$(uname -s)"
  if [ "$os_type" = "Darwin" ] && command -v brew >/dev/null 2>&1; then
    echo "Installing Node.js via Homebrew"
    brew install node || echo "Homebrew installation failed, will fallback to nvm"
  fi
  if ! command -v node >/dev/null 2>&1; then
    export NVM_DIR="$HOME/.nvm"
    if [ ! -d "$NVM_DIR" ]; then
      echo "Installing nvm (user-level Node.js manager)"
      curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    fi
    if [ -s "$NVM_DIR/nvm.sh" ]; then
      . "$NVM_DIR/nvm.sh"
      nvm install --lts
      nvm alias default 'lts/*'
    fi
  fi
  if command -v node >/dev/null 2>&1; then
    echo "Node.js ready: $(node -v)"
    return 0
  else
    echo "Node.js installation failed. Please install Node.js manually and rerun."
    return 1
  fi
}
ensure_node || echo "Warning: Node.js unavailable. coc.nvim/markdown-preview may not work."

# vim-plug: https://github.com/junegunn/vim-plug
# Minimalist Vim Plugin Manager
# Unix
plugin_file=~/.vim/autoload/plug.vim
if [ ! -f "$plugin_file" ]
then
    curl -fLo "$plugin_file" --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
else
    echo "vim-plug already exists: $plugin_file"
fi

VIMRC_FILE=~/.vimrc
VIMRC_BAK_FILE=~/.vimrc.bak
if [ -f "$VIMRC_FILE" ]; then
  if [ ! -f "$VIMRC_BAK_FILE" ]; then
    cp -p "$VIMRC_FILE" "$VIMRC_BAK_FILE"
    echo "Backed up existing ~/.vimrc to ~/.vimrc.bak"
  else
    ts="$(date +%Y%m%d-%H%M%S)"
    cp -p "$VIMRC_FILE" "${VIMRC_BAK_FILE}.${ts}"
    echo "Backed up existing ~/.vimrc to ~/.vimrc.bak.${ts}"
  fi
fi

cat > "$VIMRC_FILE" <<EOF

let g:loaded_youcompleteme = 1

" 基本编辑体验
" ----------------
" 修正退格行为
set backspace=indent,eol,start

" 关闭备份/交换文件，启用持久化撤销
set nobackup
set noswapfile
set undofile
set undodir=~/.vim/undo

" 文件编码
set encoding=utf-8

" 行号与光标
set number
set nowrap
set ruler
" 高亮当前行
set cursorline

" 缩进与空格
set cindent
set tabstop=4
set shiftwidth=4
set expandtab
set smartindent
set autoindent

" 搜索
set ic
set hls
set is
set ignorecase
set smartcase

" 模式提示与折叠
set showmode
set nofoldenable

" 分屏、剪贴板、鼠标、显示
set splitbelow
set splitright
set clipboard=unnamedplus
set mouse=a
set termguicolors
set signcolumn=yes

" 主题
syntax enable
set background=dark
" 可用主题位于: /usr/local/share/vim/vim80/colors/
colorscheme murphy


" 插件管理与配置
" ----------------
call plug#begin('~/.vim/plugged')

" 文件树
Plug 'preservim/nerdtree'
Plug 'Xuyuanp/nerdtree-git-plugin'

" 状态栏
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'

" Git
Plug 'tpope/vim-fugitive'
Plug 'airblade/vim-gitgutter'

" 注释
Plug 'tpope/vim-commentary'

" Markdown
Plug 'preservim/vim-markdown'
Plug 'iamcco/markdown-preview.nvim', { 'do': { -> mkdp#util#install() } }

" HTML/CSS/Emmet
Plug 'mattn/emmet-vim'
Plug 'othree/html5.vim'
Plug 'hail2u/vim-css3-syntax'

" JavaScript/React 语法
Plug 'pangloss/vim-javascript'
Plug 'maxmellon/vim-jsx-pretty'

" 代码检查/修复
Plug 'dense-analysis/ale'

" 模糊搜索
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
Plug 'junegunn/fzf.vim'

" 补全：coc.nvim（需安装 Node.js）
Plug 'neoclide/coc.nvim', {'branch': 'release'}
call plug#end()

" NERDTree 使用说明:
" - <C-n> 打开/关闭树
" - 在树中 ? 查看帮助
let NERDTreeShowHidden=1
nnoremap <C-n> :NERDTreeToggle<CR>
let g:NERDTreeGitStatusShowIgnored = 1
let g:NERDTreeGitStatusIndicatorMapCustom = {
    \ 'Modified'  : '✹',
    \ 'Staged'    : '✚',
    \ 'Untracked' : '✭',
    \ 'Renamed'   : '➜',
    \ 'Unmerged'  : '═',
    \ 'Deleted'   : '✖',
    \ 'Dirty'     : '✗',
    \ 'Clean'     : '✔︎',
    \ 'Ignored'   : '☒',
    \ 'Unknown'   : '?'
    \ }

" Airline
let g:airline_theme='papercolor'

" ALE 使用说明:
" - <C-j>/<C-k> 跳转到下/上一问题
let g:ale_linters = { 'javascript': ['eslint'], 'css': ['stylelint'] }
let g:ale_fixers =  { 'javascript': ['eslint'], 'css': ['stylelint'] }
let g:ale_fix_on_save = 1
let g:ale_sign_column_always = 1
let g:ale_sign_error = '●'
let g:ale_sign_warning = '▶'
nmap <silent> <C-k> <Plug>(ale_previous_wrap)
nmap <silent> <C-j> <Plug>(ale_next_wrap)

" FZF 常用命令:
" - :Files  文件搜索
" - :Rg     内容搜索（需 ripgrep）

" coc.nvim 常用映射:
nmap <silent> gd <Plug>(coc-definition)
nmap <silent> gr <Plug>(coc-references)
nmap <silent> gi <Plug>(coc-implementation)
nmap <silent> K :call CocAction('doHover')<CR>
inoremap <silent><expr> <Tab> pumvisible() ? "\<C-n>" : "\<Tab>"
inoremap <expr><S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"

" Markdown 预览
let mapleader=" "
let g:mkdp_auto_start=0
let g:mkdp_auto_close=1
nnoremap <silent> <leader>mp :MarkdownPreview<CR>
nnoremap <silent> <leader>ms :MarkdownPreviewStop<CR>
nnoremap <silent> <leader>mt :MarkdownPreviewToggle<CR>

" PlugInstall
" PlugUpdate
" PlugClean
" PlugUpgrade
" PlugStatus
" PlugDiff
" PlugSnapshot

EOF

if [ $? -eq 0 ]
then
    echo "Your vim configuration file has been generated."
    echo
    echo Tips:
    echo If you open a file with vim and see: 
    echo 
    echo    "Error detected while processing function youcompleteme#Enable[5]..<SNR>98_SetUpPython:"
    echo    "line   39:"
    echo    "E887: Sorry, this command is disabled, the Python's site module could not be loaded."
    echo
    echo You were previously using YouCompleteMe. It has been removed in favor of coc.nvim.
    echo Ensure Node.js is installed for coc.nvim to work properly.
fi
echo
echo Start Vim to Install the PlugIn specified in ~/.vimrc
if [ -d "$HOME/.vim/plugged/YouCompleteMe" ]; then
  echo "Removing legacy YouCompleteMe plugin directory"
  rm -rf "$HOME/.vim/plugged/YouCompleteMe"
fi
vim +PlugClean! +qall
vim +PlugInstall +qall
echo Now, you can use your vim IDE, enjoy it!
